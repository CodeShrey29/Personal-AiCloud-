name: Build and Release Binaries

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            build-essential autoconf automake libtool pkg-config \
            python3 python3-dev python3-pip python3-setuptools \
            libglib2.0-dev libglib2.0-dev-bin libssl-dev libevent-dev libcurl4-openssl-dev \
            libsqlite3-dev libjansson-dev libarchive-dev \
            uuid-dev intltool libfuse-dev \
            wget curl git ca-certificates \
            default-libmysqlclient-dev libldap2-dev libsasl2-dev \
            libjpeg-dev zlib1g-dev libcairo2-dev libgirepository1.0-dev \
            valac cmake libzdb-dev \
            libhiredis-dev libjwt-dev libargon2-dev \
            dos2unix

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Build libsearpc
        run: |
          git clone --depth 1 https://github.com/haiwen/libsearpc.git /tmp/libsearpc
          cd /tmp/libsearpc
          ./autogen.sh && ./configure --prefix=/usr && make -j$(nproc) && sudo make install && sudo ldconfig

      - name: Build seafile-server core
        run: |
          cd Intelligent-cloud-core
          find . -type f \( -name "*.sh" -o -name "*.ac" -o -name "*.am" -o -name "*.in" \
              -o -name "*.py" -o -name "*.m4" -o -name "*.vala" -o -name "*.c" -o -name "*.h" \
              -o -name "*.pc.in" -o -name "Makefile*" -o -name "configure*" \) -exec dos2unix {} + 2>/dev/null || true
          chmod +x autogen.sh
          ./autogen.sh
          ./configure --prefix=/usr --enable-python --disable-fuse --disable-httpserver CFLAGS="-Wno-deprecated-declarations"
          make -j$(nproc) && sudo make install

      - name: Build Go fileserver
        run: |
          cd Intelligent-cloud-core/fileserver
          go build -o fileserver .

      - name: Collect artifacts
        run: |
          mkdir -p /tmp/cloudai-binaries/{bin,lib,pypackages}

          # Binaries
          cp /usr/bin/seaf-server /tmp/cloudai-binaries/bin/
          cp /usr/bin/seafile-controller /tmp/cloudai-binaries/bin/
          cp Intelligent-cloud-core/fileserver/fileserver /tmp/cloudai-binaries/bin/

          # Libraries
          cp -a /usr/lib/libsearpc* /tmp/cloudai-binaries/lib/ 2>/dev/null || true
          cp -a /usr/lib/libseafile* /tmp/cloudai-binaries/lib/ 2>/dev/null || true
          cp -a /usr/lib/x86_64-linux-gnu/libsearpc* /tmp/cloudai-binaries/lib/ 2>/dev/null || true
          cp -a /usr/lib/x86_64-linux-gnu/libseafile* /tmp/cloudai-binaries/lib/ 2>/dev/null || true

          # pysearpc Python package (from libsearpc)
          cp -r /tmp/libsearpc/pysearpc /tmp/cloudai-binaries/pypackages/

          # seafile + seaserv Python packages
          for d in /usr/lib/python3/dist-packages /usr/lib/python3.10/dist-packages /usr/local/lib/python3/dist-packages /usr/local/lib/python3.10/dist-packages; do
              [ -d "$d/seaserv" ] && cp -r "$d/seaserv" /tmp/cloudai-binaries/pypackages/
              [ -d "$d/seafile" ] && cp -r "$d/seafile" /tmp/cloudai-binaries/pypackages/
              [ -d "$d/pysearpc" ] && cp -r "$d/pysearpc" /tmp/cloudai-binaries/pypackages/
          done

          # Also copy from the source tree as fallback
          cp -r Intelligent-cloud-core/python/seafile /tmp/cloudai-binaries/pypackages/ 2>/dev/null || true
          cp -r Intelligent-cloud-core/python/seaserv /tmp/cloudai-binaries/pypackages/ 2>/dev/null || true

          echo "=== Artifacts ==="
          find /tmp/cloudai-binaries -type f | head -50

      - name: Create tarball
        run: |
          cd /tmp/cloudai-binaries
          tar -czf $GITHUB_WORKSPACE/cloudai-binaries.tar.gz .

      - name: Delete old release
        run: |
          gh release delete build-latest --yes 2>/dev/null || true
          git push origin :refs/tags/build-latest 2>/dev/null || true
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-latest
          name: "Pre-built Cloudai Binaries"
          body: "Auto-built binaries for Render.com native deployment. Updated on each push to main."
          files: cloudai-binaries.tar.gz
          make_latest: true
